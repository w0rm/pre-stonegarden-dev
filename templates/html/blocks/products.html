$def with(block)
$# Products list grouped by subcategories for category page

$def render_products(pages):
    $  products = [p for p in pages if p.type == "product"]
    $if products:
        <ul class="catalog-products">
        $for product in products:
            <li><a class="$page_unpublished_class(product)"
                   href="$product.path">$product.title</a></li>
        </ul>

<section class="catalog-category">
    $:render_products(ctx.nav.children)
    $  categories = [c for c in ctx.nav.children if c.type == "category"]
    $if categories:
        <ul class="catalog-subcategories">
        $for category in categories:
            <li id="category_$category.id">
                <h3 class="$page_unpublished_class(category)">$category.name</h3>
                $:render_products(category.get("pages", []))
            </li>
        </ul>
</section>
